<section class="home-minimal">
  <p class="eyebrow">Company Chatter</p>
  <h2>Find a company. Read its story.</h2>
  <p class="search-subtle">{{ total_companies }} companies 路 {{ total_quotes }} quotes 路 {{ total_editions }} editions</p>

  <div class="search-shell">
    <input
      type="search"
      id="companySearch"
      placeholder="Search companies..."
      autocomplete="off"
    />
  </div>

  <p class="result-caption" id="resultCount" hidden></p>
  <div class="search-results" id="searchResults" hidden></div>
</section>

<script id="companyData" type="application/json">{{ company_data_json }}</script>
<script>
  const input = document.getElementById('companySearch');
  const resultCount = document.getElementById('resultCount');
  const searchResults = document.getElementById('searchResults');
  const companyData = JSON.parse(document.getElementById('companyData').textContent || '[]');

  function escapeHtml(value) {
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function hideResults() {
    resultCount.hidden = true;
    searchResults.hidden = true;
    searchResults.innerHTML = '';
  }

  function renderResults(rows, query) {
    if (!query) {
      hideResults();
      return;
    }

    resultCount.hidden = false;
    searchResults.hidden = false;
    resultCount.textContent = `${rows.length} matches`;

    if (!rows.length) {
      searchResults.innerHTML = '<p class="empty-state">No company found for this query.</p>';
      return;
    }

    searchResults.innerHTML = rows
      .slice(0, 10)
      .map(
        (row) => `
          <a class="result-item" href="/company/${row.slug}/">
            <strong>${escapeHtml(row.name)}</strong>
            <span>${row.quote_count} quotes 路 ${row.edition_count} editions 路 ${escapeHtml(row.latest_date)}</span>
          </a>
        `
      )
      .join('');
  }

  input.addEventListener('input', () => {
    const query = input.value.trim().toLowerCase();
    const matches = companyData.filter((row) => row.name.toLowerCase().includes(query));
    renderResults(matches, query);
  });

  hideResults();
</script>
