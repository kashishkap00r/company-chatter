<section class="home-stage">
  <div class="floating-field" aria-hidden="true">
    {{ floating_companies }}
  </div>

  <div class="search-stage">
    <p class="eyebrow">Company Chatter</p>
    <h2>Search once. Read the company story, edition by edition.</h2>
    <p class="search-subtle">{{ total_companies }} companies 路 {{ total_quotes }} quotes 路 {{ total_editions }} editions</p>

    <div class="search-shell">
      <input
        type="search"
        id="companySearch"
        placeholder="Search companies..."
        autocomplete="off"
      />
    </div>
    <p class="result-caption"><span id="resultCount">Top matches</span></p>
    <div class="search-results" id="searchResults"></div>
  </div>
</section>

<script id="companyData" type="application/json">{{ company_data_json }}</script>
<script>
  const input = document.getElementById('companySearch');
  const resultCount = document.getElementById('resultCount');
  const searchResults = document.getElementById('searchResults');
  const companyData = JSON.parse(document.getElementById('companyData').textContent || '[]');
  const floatingLinks = Array.from(document.querySelectorAll('.floating-company'));

  function escapeHtml(value) {
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderResults(rows, query) {
    if (!rows.length) {
      searchResults.innerHTML = '<p class="empty-state">No company found for this query.</p>';
      return;
    }

    searchResults.innerHTML = rows
      .slice(0, 10)
      .map(
        (row) => `
          <a class="result-item" href="/company/${row.slug}/">
            <strong>${escapeHtml(row.name)}</strong>
            <span>${row.quote_count} quotes 路 ${row.edition_count} editions 路 ${escapeHtml(row.latest_date)}</span>
          </a>
        `
      )
      .join('');

    resultCount.textContent = query ? `${rows.length} matches` : 'Top matches';
  }

  function topMatches() {
    return [...companyData]
      .sort((a, b) => (b.quote_count - a.quote_count) || a.name.localeCompare(b.name))
      .slice(0, 10);
  }

  input.addEventListener('input', () => {
    const query = input.value.trim().toLowerCase();
    if (!query) {
      renderResults(topMatches(), '');
      return;
    }
    const matches = companyData.filter((row) => row.name.toLowerCase().includes(query));
    renderResults(matches, query);
  });

  function fadeFloatingName() {
    if (!floatingLinks.length) {
      return;
    }
    const pick = floatingLinks[Math.floor(Math.random() * floatingLinks.length)];
    pick.classList.add('is-fading');
    window.setTimeout(() => pick.classList.remove('is-fading'), 1600);
    window.setTimeout(fadeFloatingName, 1100 + Math.floor(Math.random() * 1800));
  }

  renderResults(topMatches(), '');
  window.setTimeout(fadeFloatingName, 1200);
</script>
