<section class="home-minimal">
  <p class="eyebrow">Company Radar</p>
  <h2>Find a company. Read its story.</h2>
  <p class="search-subtle">{{ total_companies }} companies · {{ total_quotes }} quotes · {{ total_story_mentions }} story mentions</p>

  <div class="search-module">
    <form class="search-shell card" role="search" novalidate>
      <label class="search-field" data-field>
        <input
          type="search"
          id="companySearch"
          placeholder="Search companies..."
          autocomplete="off"
          role="combobox"
          aria-autocomplete="list"
          aria-expanded="false"
          aria-controls="searchResults"
          aria-label="Search companies"
        />
      </label>
    </form>
    <div class="search-results card" id="searchResults" role="listbox" hidden></div>
  </div>
</section>

<script id="companyData" type="application/json">{{ company_data_json }}</script>
<script id="featuredCompanyData" type="application/json">{{ featured_company_data_json }}</script>
<script>
  const searchForm = document.querySelector('.search-shell');
  const searchModule = document.querySelector('.search-module');
  const input = document.getElementById('companySearch');
  const searchResults = document.getElementById('searchResults');
  const companyData = JSON.parse(document.getElementById('companyData').textContent || '[]');
  const featuredCompanyData = JSON.parse(
    document.getElementById('featuredCompanyData').textContent || '[]'
  );
  let activeIndex = -1;
  let visibleRows = [];

  function escapeHtml(value) {
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function hideResults() {
    searchResults.hidden = true;
    searchResults.innerHTML = '';
    visibleRows = [];
    activeIndex = -1;
    input.setAttribute('aria-expanded', 'false');
    input.removeAttribute('aria-activedescendant');
  }

  function rankedMatches(query) {
    const lowered = query.toLowerCase();
    return companyData
      .filter((row) => row.name.toLowerCase().includes(lowered))
      .sort((left, right) => {
        const leftName = left.name.toLowerCase();
        const rightName = right.name.toLowerCase();
        const leftExactRank = leftName === lowered ? 0 : 1;
        const rightExactRank = rightName === lowered ? 0 : 1;
        if (leftExactRank !== rightExactRank) {
          return leftExactRank - rightExactRank;
        }

        const leftPrefixRank = leftName.startsWith(lowered) ? 0 : 1;
        const rightPrefixRank = rightName.startsWith(lowered) ? 0 : 1;
        if (leftPrefixRank !== rightPrefixRank) {
          return leftPrefixRank - rightPrefixRank;
        }

        return leftName.localeCompare(rightName);
      });
  }

  function renderRows(rows) {
    return rows
      .map(
        (row, index) => `
          <a class="result-item" id="resultOption${index}" role="option" aria-selected="false" href="/company/${row.slug}/">
            <strong>${escapeHtml(row.name)}</strong>
            <span>${row.quote_count} quotes · ${row.story_mentions_count} story mentions</span>
          </a>
        `
      )
      .join('');
  }

  function showResults(rows, resultsLabel) {
    visibleRows = rows.slice(0, 10);
    activeIndex = -1;
    input.removeAttribute('aria-activedescendant');
    input.setAttribute('aria-expanded', 'true');
    searchResults.hidden = false;

    if (!visibleRows.length) {
      searchResults.innerHTML = `
        <p class="results-meta">0 matches</p>
        <p class="empty-state">No company found for this query.</p>
      `;
      return;
    }

    searchResults.innerHTML = `
      <p class="results-meta">${resultsLabel}</p>
      ${renderRows(visibleRows)}
    `;
  }

  function renderFeaturedResults() {
    if (!featuredCompanyData.length) {
      hideResults();
      return;
    }

    showResults(featuredCompanyData.slice(0, 5), 'Featured companies');
  }

  function setActiveIndex(nextIndex) {
    const items = Array.from(searchResults.querySelectorAll('.result-item'));
    if (!items.length) {
      activeIndex = -1;
      input.removeAttribute('aria-activedescendant');
      return;
    }

    if (nextIndex < 0) {
      nextIndex = items.length - 1;
    } else if (nextIndex >= items.length) {
      nextIndex = 0;
    }

    activeIndex = nextIndex;
    items.forEach((item, index) => {
      const isActive = index === activeIndex;
      item.classList.toggle('active', isActive);
      item.setAttribute('aria-selected', String(isActive));
    });

    const activeItem = items[activeIndex];
    if (activeItem) {
      input.setAttribute('aria-activedescendant', activeItem.id);
      activeItem.scrollIntoView({ block: 'nearest' });
    }
  }

  function renderResults(rows, rawQuery) {
    const query = rawQuery.trim();
    if (!query) {
      renderFeaturedResults();
      return;
    }
    showResults(rows, `${rows.length} matches`);
  }

  input.addEventListener('input', () => {
    const query = input.value;
    renderResults(rankedMatches(query), query);
  });

  input.addEventListener('focus', () => {
    const query = input.value;
    renderResults(rankedMatches(query), query);
  });

  searchForm.addEventListener('submit', (event) => {
    event.preventDefault();
    if (activeIndex >= 0 && visibleRows[activeIndex]) {
      window.location.href = `/company/${visibleRows[activeIndex].slug}/`;
    }
  });

  input.addEventListener('keydown', (event) => {
    if (searchResults.hidden) {
      return;
    }

    if (event.key === 'Escape') {
      event.preventDefault();
      hideResults();
      return;
    }

    if (!visibleRows.length) {
      return;
    }

    if (event.key === 'ArrowDown') {
      event.preventDefault();
      setActiveIndex(activeIndex + 1);
      return;
    }

    if (event.key === 'ArrowUp') {
      event.preventDefault();
      setActiveIndex(activeIndex - 1);
      return;
    }

    if (event.key === 'Enter' && activeIndex >= 0) {
      event.preventDefault();
      window.location.href = `/company/${visibleRows[activeIndex].slug}/`;
    }
  });

  input.addEventListener('blur', () => {
    window.setTimeout(() => {
      if (!searchModule.contains(document.activeElement)) {
        hideResults();
      }
    }, 0);
  });

  searchResults.addEventListener('pointerdown', (event) => {
    if (!(event.target instanceof Element)) {
      return;
    }

    const rowLink = event.target.closest('.result-item');
    if (!rowLink) {
      return;
    }

    const href = rowLink.getAttribute('href');
    if (!href) {
      return;
    }

    event.preventDefault();
    window.location.href = href;
  });

  document.addEventListener('pointerdown', (event) => {
    if (!(event.target instanceof Element)) {
      return;
    }

    if (!event.target.closest('.search-module')) {
      hideResults();
    }
  });

  hideResults();
</script>
